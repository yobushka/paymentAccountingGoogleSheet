/**
 * @fileoverview Лист «Инструкция»
 */

/**
 * Настраивает лист «Инструкция» для v2.0
 */
function setupInstructionSheet() {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_NAMES.INSTRUCTION);
  if (!sh) return;
  
  // Очищаем старое содержимое под заголовком
  const last = sh.getLastRow();
  if (last > 1) {
    sh.getRange(2, 1, last - 1, Math.max(2, sh.getLastColumn())).clearContent();
  }
  
  const rows = [
    ['▶ О проекте', `Версия: ${APP_VERSION}. Репозиторий: https://github.com/yobushka/paymentAccountingGoogleSheet`],
    ['▶ Дисклеймер', 'Инструмент на ранней стадии и используется для личных целей; welcome to contribute. Внимание к персональным данным: передача ПДн через границу может быть незаконной. Google — иностранная компания; соблюдайте применимое законодательство.'],
    
    ['▶ Что нового в v2.0', '• Балансовая модель: платежи пополняют баланс, цели списывают с баланса\n• Свободные платежи: goal_id опционален — можно вносить без привязки к цели\n• Регулярные цели: ежемесячные/ежеквартальные с автосозданием\n• Новый режим «voluntary» — добровольные взносы\n• Расширенный баланс: Внесено - Списано - Резерв = Свободно'],
    
    ['▶ Быстрый старт', '1) Funds → Setup / Rebuild structure.\n2) Заполните «Семьи» (Активен=Да).\n3) Добавьте «Цели» (Статус=Открыта).\n4) При необходимости настройте «Участие».\n5) Вносите «Платежи».\n6) Смотрите «Баланс» и «Детализация».\n7) «Сводка» — оперативные итоги по целям.'],
    
    ['1', 'Семьи: одна строка = одна семья (один ребёнок). Заполните ФИО, День рождения (yyyy-mm-dd), контакты родителей.\n• «Активен=Да» — семья участвует по умолчанию.\n• «Членство с» — дата прихода в класс (опционально).\n• «Членство по» — дата ухода из класса (опционально).\nID генерируется автоматически.'],
    
    ['2', 'Цели: выберите «Тип» (разовая/регулярная), «Начисление» и задайте «Параметр суммы».\n• Для регулярных целей укажите «Периодичность».\n• «Фиксированный x»: для dynamic_by_payers — cap после закрытия, для unit_price — цена за единицу.\n• «К выдаче детям» — включает учёт выдачи для поштучных целей.'],
    
    ['3', 'Участие (опционально): если есть хотя бы один «Участвует», участвуют только отмеченные семьи. «Не участвует» всегда исключает семью. Если явных «Участвует» нет — участвуют все активные семьи.'],
    
    ['4', 'Платежи: выберите семью из выпадающего списка. Цель — опционально (свободный платёж пополняет баланс без привязки). Сумма должна быть > 0.'],
    
    ['5', 'Баланс v2.0:\n• Внесено всего — сумма всех платежей\n• Списано всего — сумма начислений по целям\n• Зарезервировано — под открытые цели\n• Свободный остаток — доступно для новых целей\n• Задолженность — если списано > внесено'],
    
    ['6', 'Демо-данные: Funds → Load Sample Data — добавит примеры для демонстрации.'],
    
    ['▶ Пересчёт', 'Если сменили режим/участие/платежи, выполните Funds → Recalculate (Balance & Detail). Баланс также авто‑обновляется при правках.'],
    
    ['▶ Режимы начисления (подробно)', 'Все расчёты моментальные:'],
    
    ['static_per_family', 'Фикс на семью. Начислено участнику = «Параметр суммы».\nПример: сбор на канцтовары 500₽ — каждой семье начисляется 500₽.'],
    
    ['shared_total_all', 'T/N на всех участников.\nПример: новогодний утренник 12000₽ на 10 участников = 1200₽ каждому.'],
    
    ['shared_total_by_payers', 'T/K только для оплативших.\nПример: подарок учителю 5000₽, оплатили 5 семей = 1000₽ каждому плательщику.'],
    
    ['dynamic_by_payers', 'Water-filling: Σ min(P_i, x) = min(T, ΣP_i).\nНачислено семье i = min(P_i, x). Выравнивает ранние переплаты.\nПосле закрытия используется «Фиксированный x».'],
    
    ['proportional_by_payers', 'Пропорционально платежам: начисление i = P_i × (T/ΣP).\nПока не достигнута цель — списывается весь платёж.'],
    
    ['unit_price', 'Поштучная закупка: цена за единицу x из «Фиксированный x».\nНачисление i = floor(P_i/x) × x. Остаток < x — переплата без долга.'],
    
    ['voluntary', 'Добровольный взнос (v2.0): начисление = платёж, без обязательств.\nДля благотворительных сборов без фиксированной цели.'],
    
    ['▶ Закрытие цели', 'Меню Funds → Close Goal. Введите goal_id (например, G003). Для dynamic_by_payers скрипт посчитает x и зафиксирует.'],
    
    ['▶ Формулы', 'DYN_CAP(T, payments_range) — cap x по water-filling.\nACCRUED_FAMILY(family_id, filter) — начислено семье.\nPAYED_TOTAL_FAMILY(family_id) — оплачено семьёй.\nLABEL_TO_ID("Имя (F001)") → F001.'],
    
    ['▶ Членство и период участия', '«Членство с» и «Членство по» позволяют автоматически исключать семью из целей вне периода её членства.\n\n• Семья пришла в середине года: укажите «Членство с» — взносы до этой даты не начисляются.\n• Семья ушла: укажите «Членство по» — расчёт баланса на дату ухода для выплаты остатка.\n\nФормулы:\n• EXIT_BALANCE(family_id) — баланс на дату ухода\n• MEMBERSHIP_MONTHS(family_id, год) — месяцев членства в году\n• MEMBERSHIP_RATIO(family_id, год) — коэффициент 0-1 для пропорций\n• IS_MEMBER_ON_DATE(family_id, дата) — проверка членства'],
    
    ['▶ Миграция v1→v2', 'Если у вас таблица v1.x (Сборы/collection_id), запустите Funds → Migrate v1 → v2 для автоматической конвертации.'],
    
    ['▶ Советы', '• Если дропдауны пустые — Funds → Rebuild data validations.\n• Если «Начислено» неожиданно 0 — проверьте «Участие» и «Активен».\n• Для чистки — Funds → Cleanup visuals.']
  ];
  
  sh.getRange(2, 1, rows.length, 2).setValues(rows);
  
  // Форматирование
  sh.getRange(2, 2, rows.length, 1).setWrap(true).setVerticalAlignment('top');
  
  // Выделяем секции жирным
  rows.forEach((r, i) => {
    if (String(r[0] || '').slice(0, 1) === '▶') {
      sh.getRange(2 + i, 1, 1, 2).setFontWeight('bold');
    }
  });
}

/**
 * Настраивает лист «Инструкция» для v1.x (режим совместимости)
 */
function setupInstructionSheetV1_() {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_NAMES.INSTRUCTION);
  if (!sh) return;
  
  const last = sh.getLastRow();
  if (last > 1) {
    sh.getRange(2, 1, last - 1, Math.max(2, sh.getLastColumn())).clearContent();
  }
  
  const rows = [
    ['▶ О проекте', 'Версия: 0.2 (v1.x совместимость). Репозиторий: https://github.com/yobushka/paymentAccountingGoogleSheet'],
    ['▶ Дисклеймер', 'Инструмент на ранней стадии. Внимание к персональным данным.'],
    ['▶ Быстрый старт', '1) Funds → Setup / Rebuild structure.\n2) Заполните «Семьи» (Активен=Да).\n3) Добавьте «Сборы» (Статус=Открыт).\n4) При необходимости настройте «Участие».\n5) Вносите «Платежи».\n6) Смотрите «Баланс» и «Детализация».'],
    ['1', 'Семьи: одна строка = одна семья. ID генерируется автоматически.'],
    ['2', 'Сборы: выберите «Начисление» и задайте «Параметр суммы».'],
    ['3', 'Участие: если есть «Участвует» — участвуют только отмеченные. «Не участвует» исключает.'],
    ['4', 'Платежи: выберите семью и сбор. Сумма > 0.'],
    ['5', 'Баланс: Оплачено - Начислено = Переплата/Задолженность.'],
    ['▶ Обновление', 'Доступна версия 2.0 с балансовой моделью. Funds → Migrate v1 → v2.']
  ];
  
  sh.getRange(2, 1, rows.length, 2).setValues(rows);
  sh.getRange(2, 2, rows.length, 1).setWrap(true).setVerticalAlignment('top');
  
  rows.forEach((r, i) => {
    if (String(r[0] || '').slice(0, 1) === '▶') {
      sh.getRange(2 + i, 1, 1, 2).setFontWeight('bold');
    }
  });
}
