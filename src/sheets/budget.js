/**
 * @fileoverview Лист «Смета» — настройка и структура статей бюджета
 */

/**
 * Настраивает лист «Смета» с примером структуры статей
 * НЕ перезаписывает данные, если лист уже содержит данные
 */
function setupBudgetSheet_() {
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName(SHEET_NAMES.BUDGET);
  if (!sh) return;
  
  // Проверяем, есть ли уже данные (кроме заголовков)
  const lastRow = sh.getLastRow();
  if (lastRow > 1) {
    // Лист уже содержит данные — не перезаписываем
    // Только применяем стили
    try {
      styleSheetHeader_(sh);
      styleBudgetSheet_(sh);
    } catch (_) {}
    return;
  }
  
  // Добавляем блок общих данных в верхней части (справа от основных колонок)
  setupBudgetSummary_(sh);
  
  // Добавляем пример структуры статей
  const exampleData = getBudgetExampleData_();
  if (exampleData.length > 0) {
    sh.getRange(2, 1, exampleData.length, exampleData[0].length).setValues(exampleData);
  }
  
  // Применяем стили
  SpreadsheetApp.flush();
  try {
    styleSheetHeader_(sh);
    styleBudgetSheet_(sh);
  } catch (_) {}
}

/**
 * Настраивает сводный блок с общими параметрами
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sh
 */
function setupBudgetSummary_(sh) {
  // Блок общих данных в колонках J-M
  const summaryData = [
    ['Общие данные', '', 'Итоги по статьям', ''],
    ['Количество детей', 25, 'Вода (на чел/год)', '=SUMIF(A:A,"Вода",H:H)/J2'],
    ['Девочек', 12, 'Подарки учителям (на чел/год)', '=SUMIF(A:A,"Подарки учителям",H:H)/J2'],
    ['Мальчиков', 13, 'Подарки детям (на чел/год)', '=SUMIF(A:A,"Подарки детям",H:H)/J2'],
    ['Рабочих дней/мес', 22, 'Хозтовары (на чел/год)', '=SUMIF(A:A,"Хозтовары",H:H)/J2'],
    ['', '', '', ''],
    ['', '', 'Итого на человека/год', '=SUM(L2:L5)'],
    ['', '', 'Общий годовой бюджет', '=L7*J2'],
  ];
  
  sh.getRange('J1:M8').setValues(summaryData);
  sh.getRange('J1:K1').merge().setFontWeight('bold').setBackground('#e8f0fe');
  sh.getRange('L1:M1').merge().setFontWeight('bold').setBackground('#e8f0fe');
  sh.getRange('J7:K7').merge();
  sh.getRange('J8:K8').merge();
  sh.getRange('L7:L8').setFontWeight('bold');
  sh.getRange('M7:M8').setNumberFormat('#,##0.00 ₽');
  sh.getRange('L2:L5').setNumberFormat('#,##0.00 ₽');
  sh.getRange('M2:M5').setNumberFormat('#,##0.00 ₽');
}

/**
 * Возвращает пример данных для сметы (анонимизированные данные)
 * @returns {Array<Array>}
 */
function getBudgetExampleData_() {
  return [
    // Статья, Подстатья, Описание, Параметр, Значение, Ед.изм., Расчёт, Итого
    
    // === ВОДА ===
    ['Вода', 'Бутылки 19л', 'Доставка питьевой воды', 'Расход на чел/день', 150, 'мл', '', ''],
    ['Вода', 'Бутылки 19л', '', 'Объём бутылки', 19000, 'мл', '', ''],
    ['Вода', 'Бутылки 19л', '', 'Цена бутылки', 350, '₽', '', ''],
    ['Вода', 'Бутылки 19л', '', 'Бутылок в месяц', '', '', '=ROUNDUP(J2*150*22/19000,0)', ''],
    ['Вода', 'Бутылки 19л', '', 'Стоимость/мес', '', '₽', '=G5*350', '=G6'],
    ['Вода', 'Стаканчики', 'Одноразовые 50мл', 'Цена упаковки (200шт)', 250, '₽', '', ''],
    ['Вода', 'Стаканчики', '', 'Расход стаканов/день', 25, 'шт', '', ''],
    ['Вода', 'Стаканчики', '', 'Стоимость/мес', '', '₽', '=ROUNDUP(G8*22/200,0)*250', '=G9'],
    ['Вода', 'Обслуживание кулера', 'Раз в квартал', 'Стоимость обслуживания', 1200, '₽', '', ''],
    ['Вода', 'Обслуживание кулера', '', 'Стоимость/мес', '', '₽', '=G10/3', '=G11'],
    ['Вода', '', '', 'ИТОГО ВОДА/мес', '', '₽', '=H6+H9+H11', '=G12'],
    ['Вода', '', '', 'ИТОГО ВОДА/год (9 мес)', '', '₽', '=H12*9', '=G13'],
    
    // === ПОДАРКИ УЧИТЕЛЯМ ===
    ['Подарки учителям', 'Классный руководитель', 'Основной педагог', 'День учителя', 2500, '₽', '', ''],
    ['Подарки учителям', 'Классный руководитель', '', '8 марта / 23 февраля', 2000, '₽', '', ''],
    ['Подарки учителям', 'Классный руководитель', '', 'День рождения', 2500, '₽', '', ''],
    ['Подарки учителям', 'Классный руководитель', '', 'Новый год', 2000, '₽', '', ''],
    ['Подарки учителям', 'Классный руководитель', '', 'Итого', '', '₽', '=SUM(E14:E17)', '=G18'],
    ['Подарки учителям', 'Учитель предметник 1', 'Предметный педагог', 'День учителя', 1000, '₽', '', ''],
    ['Подарки учителям', 'Учитель предметник 1', '', 'Новый год', 1000, '₽', '', ''],
    ['Подарки учителям', 'Учитель предметник 1', '', 'Итого', '', '₽', '=SUM(E19:E20)', '=G21'],
    ['Подарки учителям', 'Учитель предметник 2', 'Предметный педагог', 'День учителя', 1000, '₽', '', ''],
    ['Подарки учителям', 'Учитель предметник 2', '', 'Новый год', 1000, '₽', '', ''],
    ['Подарки учителям', 'Учитель предметник 2', '', 'Итого', '', '₽', '=SUM(E22:E23)', '=G24'],
    ['Подарки учителям', '', '', 'ИТОГО ПОДАРКИ УЧИТЕЛЯМ', '', '₽', '=H18+H21+H24', '=G25'],
    
    // === ПОДАРКИ ДЕТЯМ ===
    ['Подарки детям', 'День рождения', 'Подарок каждому ребёнку', 'Цена подарка', 400, '₽', '', ''],
    ['Подарки детям', 'День рождения', '', 'Итого', '', '₽', '=E26*J2', '=G27'],
    ['Подарки детям', 'Новый год', 'Подарок каждому ребёнку', 'Цена подарка', 400, '₽', '', ''],
    ['Подарки детям', 'Новый год', '', 'Итого', '', '₽', '=E28*J2', '=G29'],
    ['Подарки детям', '23 февраля', 'Подарок мальчикам', 'Цена подарка', 400, '₽', '', ''],
    ['Подарки детям', '23 февраля', '', 'Итого', '', '₽', '=E30*J4', '=G31'],
    ['Подарки детям', '8 марта', 'Подарок девочкам', 'Цена подарка', 400, '₽', '', ''],
    ['Подарки детям', '8 марта', '', 'Итого', '', '₽', '=E32*J3', '=G33'],
    ['Подарки детям', '', '', 'ИТОГО ПОДАРКИ ДЕТЯМ', '', '₽', '=H27+H29+H31+H33', '=G34'],
    
    // === ХОЗТОВАРЫ ===
    ['Хозтовары', 'Канцелярия', 'Конверты, файлы, бумага', 'Бюджет на год', 3000, '₽', '', '=E35'],
    ['Хозтовары', 'Прочее', 'Прочие нужды класса', 'Бюджет на год', 4000, '₽', '', '=E36'],
    ['Хозтовары', '', '', 'ИТОГО ХОЗТОВАРЫ', '', '₽', '=SUM(H35:H36)', '=G37'],
  ];
}

/**
 * Применяет стили к листу «Смета»
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sh
 */
function styleBudgetSheet_(sh) {
  const lastRow = Math.max(sh.getLastRow(), 2);
  const lastCol = 8; // H - Итого
  
  // Заливка для статей (первый столбец)
  const data = sh.getRange(2, 1, lastRow - 1, 1).getValues();
  const colors = {
    'Вода': '#e3f2fd',
    'Подарки учителям': '#fff3e0',
    'Подарки детям': '#fce4ec',
    'Хозтовары': '#e8f5e9'
  };
  
  for (let i = 0; i < data.length; i++) {
    const article = data[i][0];
    if (colors[article]) {
      sh.getRange(i + 2, 1, 1, lastCol).setBackground(colors[article]);
    }
    // Выделяем строки ИТОГО
    const row = sh.getRange(i + 2, 1, 1, lastCol);
    const param = sh.getRange(i + 2, 4).getValue();
    if (String(param).toUpperCase().startsWith('ИТОГО')) {
      row.setFontWeight('bold');
    }
  }
  
  // Форматирование чисел
  sh.getRange(2, 5, lastRow - 1, 1).setNumberFormat('#,##0.00'); // Значение
  sh.getRange(2, 8, lastRow - 1, 1).setNumberFormat('#,##0.00 ₽'); // Итого
  
  // Ширина колонок сводки
  sh.setColumnWidth(10, 160); // J
  sh.setColumnWidth(11, 80);  // K
  sh.setColumnWidth(12, 200); // L
  sh.setColumnWidth(13, 140); // M
}
