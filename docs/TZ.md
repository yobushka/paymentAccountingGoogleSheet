Техническое задание (ТЗ)
Система учёта сборов средств в Google Sheets (1 семья = 1 ребёнок)
1. Цель проекта

Создать простую и прозрачную систему учёта родительских взносов на базе Google Sheets с автоматическими расчётами начислено/оплачено/переплата/долг по каждой семье, поддержкой разных типов сборов и минимальным порогом входа (без серверов и БД).

2. Область применения

Класс/группа до ~30 семей.

Срок эксплуатации — до 1 года (историчность не критична).

Работа в интерфейсе Google Sheets; логика — Google Apps Script.

3. Термины

Семья — 1 ребёнок (логика «1 семья = 1 ребёнок»).

Сбор — событие/цель, по которой нужно собрать деньги (на уровне всего сбора, без “статей”).

Участие — список семей, участвующих в сборе (по умолчанию — все активные).

Переплата — сумма превышения «Оплачено» над «Начислено».

4. Ограничения и не-цели

Нет уведомлений/ботов/интеграций.

Нет импорта банковских выписок.

Даты платежей используются только справочно (не влияют на расчёт).

5. Требования к функционалу
5.1. Вкладки (листы)

Инструкция — пошаговое руководство (заполняется скриптом).

Семьи

Поля: family_id, Ребёнок ФИО, контакты мамы/папы, Активен (Да/Нет), Комментарий.

family_id формата F001.

Сборы

Поля: collection_id, Название, Статус (Открыт/Закрыт), Дата начала, Дедлайн,
Начисление, Параметр суммы, Фиксированный x, Комментарий.

collection_id формата C001.

Типы начисления (ровно 3):

static_per_child — фикс на семью (1 семья = 1 ребёнок).

shared_total_all — общая сумма делится на всех участников (по 1 доле на семью).

dynamic_by_payers — «размазывание» цели T между фактически оплатившими методом water-filling (cap x).

Участие (опционально)

Поля: collection_id (label), family_id (label), Статус (Участвует/Не участвует), Комментарий.

Правила:

Если есть хоть одна запись Участвует по сбору → участвуют только отмеченные.

Иначе участвуют все Активные, минус все Не участвует.

Платежи

Поля: payment_id, Дата (информативно), family_id (label), collection_id (label), Сумма (>0), Способ (СБП/карта/наличные), Комментарий.

payment_id формата PMT001.

Баланс

Поля: family_id, Название семьи, Начислено всего, Оплачено всего, Переплата, Задолженность.

DynCalc — служебная (для cap x), опционально.

Lists (скрытая) — динамические списки для выпадающих.

5.2. Выпадающие списки (UX)

Отображение в дропдаунах всегда «Название (ID)»:

Семьи — Ребёнок ФИО (Fxxx)

Сборы — Название (Cxxx)

Для вычислений ID извлекается регулярным выражением: \(([^)]+)\)$.

5.3. Автоматизация (меню Funds)

Setup / Rebuild structure — создаёт/перестраивает структуру, инструкцию, named ranges, валидации.

Rebuild data validations — обновляет все валидации.

Generate IDs (all sheets) — проставляет отсутствующие ID в «Семьи/Сборы/Платежи».

Close Collection (fix x & set Closed)

Для dynamic_by_payers: считает cap x по water-filling на основании фактических платежей по сбору и фиксирует в поле Фиксированный x, устанавливает Статус=Закрыт.

Для остальных режимов: записывает x = Параметр суммы (справочно) и закрывает по требованию.

Load Sample Data (separate) — отдельный наполнитель сэмплами (семьи, сборы, участие, платежи) для демонстрации.

5.4. Кастомные функции (для формул)

LABEL_TO_ID(value) — извлечь ID из «Название (ID)» или вернуть исходное, если это ID.

PAYED_TOTAL_FAMILY(familyLabelOrId) — сумма всех платежей семьи (по всем сборам).

ACCRUED_FAMILY(familyLabelOrId, statusFilter) — начислено семье с учётом режима и участия;
statusFilter = "OPEN" (по умолчанию) или "ALL".

DYN_CAP(T, payments_range) — cap x для динамического распределения.

5.5. Алгоритмы начисления

Для конкретного сбора и семьи i:

static_per_child:

Если семья участвует → начислено = Параметр суммы; иначе 0.

shared_total_all:

Если семья участвует → начислено = Параметр суммы / N, где N — число участвующих семей.

dynamic_by_payers:

Пусть P_i — сумма платежей семьи по сбору; T — целевая сумма сбора.

Находим x такое, что Σ min(P_i, x) = min(T, Σ P_i) (water-filling).

Начислено семье i = min(P_i, x).

При закрытии сбора x фиксируется (перестаёт пересчитываться).

5.6. Баланс (формулы)

Начислено = ACCRUED_FAMILY(family_id, "OPEN") (или "ALL")

Оплачено = PAYED_TOTAL_FAMILY(family_id)

Переплата = MAX(0; Оплачено − Начислено)

Задолженность = MAX(0; Начислено − Оплачено)

6. Нефункциональные требования

Простота: работа только в Google Sheets; все операции доступны без кода.

Производительность: до 30 семей, десятки сборов и платежей — расчёты мгновенные.

Надёжность: все расчёты детерминированы формулами/скриптами; действие «Закрыть сбор» фиксирует состояние.

Прозрачность: понятные листы и формулы; минимум скрытой логики.

Локализация: интерфейс и подписи на русском.

7. Проверки и валидации

В «Платежи» сумма должна быть > 0.

Дропдауны:

В «Участие»: collection_id — только Открытые; family_id — только Активные.

В «Платежи»: все семьи/все сборы (в т.ч. закрытые — возможны поздние платежи/возвраты).

Защита от пустых ID: пункт меню Generate IDs.

Обработка ручного ввода чистого ID (без «Название (ID)») — допускается, парсер корректен.

8. Тестовые сценарии (приёмочные критерии)

Структура: после Setup создаются все листы, валидации и инструкция.

ID: Generate IDs заполняет пустые ID корректно и последовательно (F001, C001, PMT001).

Дропдауны:

«Участие» показывает только открытые сборы и активные семьи (в виде «Название (ID)»).

«Платежи» показывает все семьи/сборы (в виде «Название (ID)»).

static_per_child: при Параметр суммы=500 и участии семьи начисление = 500; при «Не участвует» — 0.

shared_total_all: при T=12000 и N=8 начисление каждой участвующей семьи = 1500; исключённые семьи — 0.

dynamic_by_payers:

До закрытия: начислено семье i = min(P_i, x) по текущему x.

Close Collection фиксирует x и ставит статус «Закрыт».

После закрытия пересчёты используют зафиксированный x.

Баланс: корректно показывает Начислено, Оплачено, Переплата, Задолженность для каждой семьи; обновляется мгновенно при добавлении платежа.

Даты: изменение дат платежей не влияет на суммы (только отображение/фильтры).

Сэмплы: Load Sample Data добавляет демонстрационные данные, все расчёты верны.

9. Поставка (Deliverables)

Файл Code.gs с реализацией Apps Script (меню, функции, логика списков и расчётов).

Файл COPILOT.md / .github/copilot-instructions.md (ориентиры для разработки).

README.md (краткая инструкция для пользователей — опционально).

10. Этапы работ

Подготовка Code.gs, первичная сборка в тестовой таблице.

Проверка по чек-листу (раздел 8).

Передача заказчику и запуск на боевой таблице.

(Опционально) Доработки: «Отчёты», массовое закрытие динамических сборов, экспорт PDF.

11. Риски и меры

Пользователи вводят не по шаблону → предусмотреть чёткие подписи и валидации.

Случайное удаление формул в скрытом листе Lists → кнопка Setup / Rebuild восстанавливает.

Редакторы могут менять статусы/активность — дропдауны обновляются формулами; при сомнении — Rebuild validations.

12. Критерии успешности

Класс из ~30 семей успешно ведёт 3–5 сборов параллельно.

Казначей без формул и кода может вносить платежи и видеть балансы.

Для динамических сборов итоговое распределение корректно фиксируется функцией закрытия.

Все суммы в «Баланс» совпадают с ручным пересчётом.