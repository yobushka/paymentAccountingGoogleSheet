ChatGPT сказал:
Funds Tracker — VS Code Copilot Instructions

Этот файл описывает цели проекта, функционал и правила разработки в формате, удобном для GitHub Copilot / VS Code. Его можно сохранить как COPILOT.md или .github/copilot-instructions.md в корне репозитория.

Кратко о продукте

Система учёта сборов в Google Sheets для класса/группы:

1 семья = 1 ребёнок.

Без «статей» — сборы задаются целиком на уровне одной строки.

Моментальные расчёты: все суммы считаются по текущим данным, даты имеют значение только для платежей (для справки и возможной фильтрации).

Выпадающие списки показывают человекочитаемые метки формата Название (ID), формулы/скрипты извлекают ID автоматически.

Есть динамический режим распределения взносов (dynamic_by_payers) по принципу water-filling (cap x).

Структура таблицы (вкладки)

Инструкция — пошаговое использование.

Семьи — справочник семей и контактов (1 строка = 1 семья/ребёнок).

Сборы — список сборов (режим начисления, суммы, статус, фиксированный x).

Участие — выбор участников для конкретных сборов (опционально).

Платежи — поступившие суммы (дата — справочная).

Баланс — расчёты начислено/оплачено/переплата/задолженность по семьями.

DynCalc — служебная вкладка для расчётов x (опционально).

Lists (скрытая) — динамические списки для выпадающих (только открытые сборы, только активные семьи и т.п.).

Модель данных (поля, ключи)

ID-шники:

family_id → F001, F002, …

collection_id → C001, C002, …

payment_id → PMT001, PMT002, …

Семьи: family_id, Ребёнок ФИО, контакты мамы/папы, Активен.

Сборы: collection_id, Название, Статус, Начисление, Параметр суммы, Фиксированный x.

Участие: collection_id (label), family_id (label), Статус = «Участвует» | «Не участвует».

Платежи: payment_id, Дата (информ.), family_id (label), collection_id (label), Сумма, Способ.

Режимы начисления (обязательно)

static_per_child — фикс на семью (в проекте 1 семья = 1 ребёнок).

shared_total_all — общая сумма делится на число участников (по 1 доле на семью).

dynamic_by_payers — цель T «размазывается» между оплатившими с выравниванием cap x (water-filling):

x такое, что Σ min(P_i, x) = min(T, Σ P_i), где P_i — взнос семьи.

«Ранние» переплаты выравниваются по мере поступления взносов остальных.

Бизнес-правила

По умолчанию участники сбора — все активные семьи.

Если в «Участие» есть хотя бы один Участвует для сбора → участники = только указанные Участвует.

Не участвует всегда исключает семью из участников (если Участвует не задан — исключение от «все активные»).

Выпадающие списки показывают метки Название (ID). Для вычислений ID извлекается регуляркой.

Даты в «Платежи» — не влияют на расчёты, только справка/фильтры.

Функции меню (Apps Script)

В Google Sheets → меню Funds:

Setup / Rebuild structure — создать/обновить структуру листов, валидации, инструкции.

Rebuild data validations — пересоздать валидаторы выпадающих списков.

Generate IDs (all sheets) — автозаполнение пустых ID на ключевых листах.

Close Collection (fix x & set Closed) — посчитать x для dynamic_by_payers, записать его в сбор и закрыть.

Load Sample Data (separate) — отдельный наполнитель демо-данными: семьи, сборы, участие, платежи.

Кастомные функции (для формул листа)

LABEL_TO_ID(value) — извлекает ID из строки Название (ID) или возвращает исходное, если уже ID.

PAYED_TOTAL_FAMILY(familyLabelOrId) — сумма всех платежей семьи (по всем сборам).

ACCRUED_FAMILY(familyLabelOrId, statusFilter) — начислено семье с учётом режимов и участия;
statusFilter = "OPEN" (по умолчанию) или "ALL".

DYN_CAP(T, payments_range) — возвращает cap x для динамического распределения цели T.

Формат выпадающих списков

На скрытом листе Lists формируем label-списки:

OPEN_COLLECTIONS_LABELS: только открытые сборы → Название (Cxxx)

COLLECTIONS_LABELS: все сборы → Название (Cxxx)

ACTIVE_FAMILIES_LABELS: только активные семьи → Ребёнок ФИО (Fxxx)

FAMILIES_LABELS: все семьи → Ребёнок ФИО (Fxxx)

Валидации используют эти именованные диапазоны.

Расчёт «Баланс»

На «Баланс» для каждой family_id:

Начислено: =ACCRUED_FAMILY(A2, "OPEN")
(можно "ALL", если нужно учитывать закрытые).

Оплачено: =PAYED_TOTAL_FAMILY(A2)

Переплата: MAX(0, Оплачено − Начислено)

Задолженность: MAX(0, Начислено − Оплачено)

Примеры сценариев (смоделировано в сэмплах)

Канцтовары — static_per_child, 500 ₽/семью.

Новый год — shared_total_all, T = 12 000 ₽, участие: 8 семей.

Подарок учителю — dynamic_by_payers, T = 9 000 ₽, несколько семей исключены, часть платит раньше/больше — x выравнивает доли при закрытии.

Нефункциональные требования

Прозрачность данных (всё видно в таблице; минимум «магии»).

Низкий порог входа — пользователь работает в Google Sheets.

Производительность: ориентир — 30 семей, десятки сборов/платежей — без лагов.

Совместимость: без внешних библиотек, только Apps Script.

Как запускать (для пользователей)

Открыть пустую Google Таблицу → Расширения → Apps Script → вставить Code.gs → сохранить.

В таблице: Funds → Setup / Rebuild structure.

Заполнить «Семьи», создать «Сборы», при необходимости «Участие».

Вносить «Платежи» через выпадающие «Название (ID)».

Смотреть «Баланс». Для динамических — «Close Collection».

Контрольный список (test checklist)