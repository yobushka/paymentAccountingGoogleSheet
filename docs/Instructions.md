# Funds Tracker v2.0 — Инструкции разработчика

Этот файл описывает цели проекта, функционал и правила разработки. 
Основной источник инструкций для Copilot: `.github/copilot-instructions.md`

## Кратко о продукте

Система учёта сборов в Google Sheets для класса/группы:

- 1 семья = 1 ребёнок
- Без «статей» — цели задаются целиком на уровне одной строки
- Моментальные расчёты: все суммы считаются по текущим данным
- Выпадающие списки показывают метки формата «Название (ID)»
- Динамический режим распределения взносов (water-filling)

## Версия 2.0 — Ключевые изменения

### Балансовая модель
- Платежи пополняют баланс семьи
- Цели списывают с баланса
- Свободные платежи (без привязки к цели)
- Баланс = Внесено − Списано − Резерв = Свободно

### Терминология
- `collection_id` → `goal_id`
- «Сборы» → «Цели»
- C001 → G001

### Новые возможности
- Типы целей: разовая / регулярная
- Режим `voluntary` — добровольный взнос без долга
- Периодичность: ежемесячно / ежеквартально / ежегодно
- Миграция v1 → v2

## Структура таблицы (вкладки)

| Лист | Назначение |
|------|------------|
| Инструкция | Пошаговое использование |
| Семьи | Справочник семей (1 строка = 1 семья/ребёнок) |
| Цели | Список целей (режим начисления, суммы, статус) |
| Участие | Выбор участников для конкретных целей (опционально) |
| Платежи | Поступившие суммы (дата — справочная) |
| Баланс | Внесено/Списано/Зарезервировано/Свободно/Долг |
| Детализация | Разбивка по семьям и целям |
| Сводка | Итоги по целям |
| Выдача | Журнал вручений (для поштучных целей) |
| Статус выдачи | Дашборд выдачи |
| Lists (скрытая) | Динамические списки для выпадающих |

## Модель данных

### ID-шники
- `family_id` → F001, F002, …
- `goal_id` → G001, G002, …
- `payment_id` → PMT001, PMT002, …

### Поля основных листов

**Семьи**: family_id, Имя ребёнка, контакты мамы/папы, Активен

**Цели**: goal_id, Название цели, Тип (разовая/регулярная), Статус (Открыта/Закрыта/Отменена), Начисление, Параметр суммы, Фиксированный x, Периодичность, Родительская цель

**Участие**: goal_id (label), family_id (label), Статус = «Участвует» | «Не участвует»

**Платежи**: payment_id, Дата, family_id (label), goal_id (label) — опционально, Сумма, Способ

## Режимы начисления

| Режим | Описание |
|-------|----------|
| `static_per_family` | Фикс на семью |
| `shared_total_all` | Общая сумма делится на всех участников |
| `shared_total_by_payers` | Общая сумма делится между оплатившими |
| `dynamic_by_payers` | Water-filling: cap x выравнивает доли |
| `proportional_by_payers` | Пропорционально взносам |
| `unit_price` | Поштучно (кратно цене x) |
| `voluntary` | Добровольно (списывается сколько внесено) |

## Бизнес-правила

- По умолчанию участники цели — все активные семьи
- Если в «Участие» есть хотя бы один «Участвует» → участники = только указанные
- «Не участвует» всегда исключает семью
- Выпадающие списки показывают метки «Название (ID)». ID извлекается автоматически
- Даты в «Платежи» — не влияют на расчёты, только справка

## Функции меню (Apps Script)

В Google Sheets → меню **Funds**:

| Пункт | Действие |
|-------|----------|
| Setup / Rebuild structure | Создать/обновить структуру листов |
| Rebuild data validations | Пересоздать валидаторы |
| Generate IDs (all sheets) | Автозаполнение пустых ID |
| Close Goal (fix x & set Closed) | Закрыть цель, зафиксировать x |
| Load Sample Data | Загрузить демо-данные |
| Migrate to v2.0 | Миграция с v1.x |
| Quick Help | Краткая справка |

## Кастомные функции (для формул)

```javascript
LABEL_TO_ID(value)           // извлекает ID из «Название (ID)»
PAYED_TOTAL_FAMILY(family)   // сумма всех платежей семьи
ACCRUED_FAMILY(family, statusFilter)  // начислено семье; statusFilter: "OPEN"/"ALL"
DYN_CAP(T, payments_range)   // cap x для water-filling
```

## Именованные диапазоны (Lists)

| Диапазон | Содержимое |
|----------|------------|
| `OPEN_GOALS_LABELS` | Открытые цели «Название (Gxxx)» |
| `GOALS_LABELS` | Все цели |
| `ACTIVE_FAMILIES_LABELS` | Активные семьи «Имя (Fxxx)» |
| `FAMILIES_LABELS` | Все семьи |

## Расчёт «Баланс» (v2.0)

Для каждой family_id:
- **Внесено всего** = сумма всех платежей
- **Списано всего** = сумма начислений по всем целям
- **Зарезервировано** = суммы по открытым целям
- **Свободный остаток** = Внесено − Списано − Резерв
- **Задолженность** = MAX(0, Списано − Внесено)

## Модульная архитектура

Код разбит на 23 модуля в `src/`:

```
src/
├── config/           # constants.js, sheets-spec.js
├── utils/            # utils.js
├── calculations/     # dyn-cap.js, custom-functions.js, recalculate.js
├── sheets/           # balance.js, detail.js, summary.js, ...
├── core/             # init.js, validations.js, id-generator.js, ...
├── ui/               # menu.js, styles.js, dialogs.js
├── triggers/         # on-edit.js
└── migration/        # detect-version.js, migrate-v1-to-v2.js
```

### Сборка
```bash
npm run build      # Собрать Code.gs из модулей
npm run validate   # Проверить наличие модулей
npm test           # Запустить тесты
```

## Как запускать (для пользователей)

1. Открыть пустую Google Таблицу → Расширения → Apps Script → вставить Code.gs → сохранить
2. В таблице: Funds → Setup / Rebuild structure
3. Заполнить «Семьи», создать «Цели», при необходимости «Участие»
4. Вносить «Платежи» через выпадающие «Название (ID)»
5. Смотреть «Баланс». Для динамических — Funds → Close Goal

## Нефункциональные требования

- Прозрачность данных (всё видно в таблице; минимум «магии»)
- Низкий порог входа — пользователь работает в Google Sheets
- Производительность: 30+ семей, десятки целей/платежей — без лагов
- Совместимость: без внешних библиотек, только Apps Script

## Контрольный список (test checklist)

- [ ] Setup создаёт все листы, валидации и инструкцию
- [ ] Generate IDs заполняет пустые ID (F001, G001, PMT001)
- [ ] Участие: показывает только открытые цели и активные семьи
- [ ] Платежи: показывает все семьи/цели; сумма > 0
- [ ] static_per_family: участнику начисляется Параметр суммы
- [ ] shared_total_all: начисление = T/N для участвующих
- [ ] dynamic_by_payers: до закрытия x пересчитывается; после — фиксируется
- [ ] voluntary: начислено = внесено (без долга)
- [ ] Баланс v2.0: Внесено/Списано/Резерв/Свободно/Долг корректны
- [ ] Миграция: C001 → G001, «Сборы» → «Цели», бэкап создаётся
