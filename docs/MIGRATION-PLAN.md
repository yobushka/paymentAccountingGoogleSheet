# План реализации миграции v1.x → v2.0

## Обзор

Этот документ описывает пошаговый план реализации механизма миграции данных из версии 1.x (целевые платежи) в версию 2.0 (балансовая модель).

---

## Фаза 1: Подготовка (Preparation)

### 1.1. Создать утилиты миграции

```javascript
// migration/utils.js

/**
 * Определяет версию текущей структуры таблицы
 * @returns {'1.x' | '2.0' | 'new'}
 */
function detectVersion_() { ... }

/**
 * Создаёт резервные копии листов
 * @returns {string} timestamp бэкапа
 */
function createMigrationBackup_() { ... }

/**
 * Создаёт маппинг старых ID на новые
 * @returns {Object<string, string>} {oldId: newId}
 */
function createIdMapping_() { ... }
```

### 1.2. Тесты для утилит

```javascript
// tests/migration.test.js

describe('Migration Utils', () => {
  it('detectVersion returns 1.x for old structure', () => { ... });
  it('detectVersion returns 2.0 for new structure', () => { ... });
  it('createIdMapping converts C001 to G001', () => { ... });
});
```

---

## Фаза 2: Трансформация структуры (Structure)

### 2.1. Миграция листа «Сборы» → «Цели»

**Задачи:**
- [ ] Переименовать лист
- [ ] Добавить новые колонки: `Тип цели`, `Периодичность`, `Приоритет списания`
- [ ] Обновить заголовки: `collection_id` → `goal_id`
- [ ] Конвертировать значения ID: `C001` → `G001`
- [ ] Обновить статусы: `Открыт` → `Открыта`

**Маппинг полей:**

| v1.x | v2.0 | Действие |
|------|------|----------|
| `collection_id` | `goal_id` | Rename + transform value |
| `Название сбора` | `Название` | Rename |
| `Статус` | `Статус` | Transform value |
| `Начисление` | `Режим начисления` | Rename |
| — | `Тип цели` | Add (default: `разовая`) |
| — | `Периодичность` | Add (default: empty) |
| — | `Приоритет списания` | Add (default: 10) |

### 2.2. Миграция листа «Платежи»

**Задачи:**
- [ ] Переименовать колонку `collection_id (label)` → `goal_id (label)`
- [ ] Обновить значения ID в ячейках
- [ ] Сделать `goal_id` опциональным (разрешить пустые значения)

### 2.3. Миграция листа «Участие»

**Задачи:**
- [ ] Переименовать колонку `collection_id (label)` → `goal_id (label)`
- [ ] Обновить значения ID в ячейках

### 2.4. Обновление листа «Баланс»

**Новая структура:**

| Колонка | Формула |
|---------|---------|
| `family_id` | Из Семьи |
| `Имя ребёнка` | VLOOKUP |
| `Внесено всего` | `=TOTAL_PAID_FAMILY(A2)` |
| `Списано всего` | `=TOTAL_CHARGED_FAMILY(A2, "CLOSED")` |
| `Текущий баланс` | `=C2-D2` |
| `Зарезервировано` | `=TOTAL_CHARGED_FAMILY(A2, "OPEN")` |
| `Свободный остаток` | `=E2-F2` |
| `Задолженность` | `=MAX(0, -G2)` |

---

## Фаза 3: Обновление логики (Logic)

### 3.1. Новые кастомные функции

```javascript
// Общая сумма всех платежей семьи (без привязки к цели)
function TOTAL_PAID_FAMILY(familyId) { ... }

// Сумма начислений по целям
// statusFilter: "OPEN" | "CLOSED" | "ALL"
function TOTAL_CHARGED_FAMILY(familyId, statusFilter) { ... }

// Текущий баланс = Внесено - Списано
function BALANCE_FAMILY(familyId) { ... }

// Зарезервировано под открытые цели
function RESERVED_FAMILY(familyId) { ... }

// Свободный остаток = Баланс - Резерв
function FREE_BALANCE_FAMILY(familyId) { ... }

// Задолженность
function DEBT_FAMILY(familyId) { ... }
```

### 3.2. Алиасы для обратной совместимости

```javascript
// Старые функции продолжают работать
function PAYED_TOTAL_FAMILY(familyLabelOrId) {
  return TOTAL_PAID_FAMILY(familyLabelOrId);
}

function ACCRUED_FAMILY(familyLabelOrId, statusFilter) {
  return TOTAL_CHARGED_FAMILY(familyLabelOrId, statusFilter);
}
```

### 3.3. Обновление режимов начисления

Для режимов, которые требуют указания цели в платеже:
- `shared_total_by_payers` — считает только целевые платежи
- `dynamic_by_payers` — считает только целевые платежи
- `voluntary` — **новый режим**, начисление = сумма целевого платежа

Для режимов без привязки:
- `static_per_family` — фикс, не зависит от платежей
- `shared_total_all` — делим на всех участников

---

## Фаза 4: Валидации и UI (Validation)

### 4.1. Обновить валидации

```javascript
function rebuildValidationsV2_() {
  // Платежи: goal_id теперь опциональный
  setValidationNamedRangeOrEmpty_(shPay, col, 'GOALS_LABELS');
  
  // Участие: только открытые цели
  setValidationNamedRange_(shPart, col, 'OPEN_GOALS_LABELS');
}
```

### 4.2. Обновить именованные диапазоны

| Старое имя | Новое имя |
|------------|-----------|
| `COLLECTIONS_LABELS` | `GOALS_LABELS` |
| `OPEN_COLLECTIONS_LABELS` | `OPEN_GOALS_LABELS` |

### 4.3. Обновить меню

```javascript
function onOpen() {
  const version = detectVersion_();
  
  if (version === '1.x') {
    // Показать меню миграции
    addMigrationMenu_();
  }
  
  // Основное меню
  addMainMenu_();
}
```

---

## Фаза 5: Тестирование (Testing)

### 5.1. Unit-тесты

```javascript
describe('Migration', () => {
  describe('ID Transformation', () => {
    it('converts C001 to G001', () => {
      expect(transformCollectionId('C001')).toBe('G001');
    });
    
    it('preserves label format', () => {
      expect(transformLabel('Новый год (C002)')).toBe('Новый год (G002)');
    });
  });
  
  describe('Data Integrity', () => {
    it('preserves total payments sum', () => { ... });
    it('preserves participation records', () => { ... });
  });
});
```

### 5.2. Интеграционные тесты

| # | Сценарий | Ожидание |
|---|----------|----------|
| 1 | Миграция пустой таблицы | Создаётся структура v2 |
| 2 | Миграция с 10 семьями, 5 сборами | Все данные сохранены |
| 3 | Миграция с платежами | Суммы совпадают |
| 4 | Откат после миграции | Восстановлена структура v1 |
| 5 | Повторная миграция | Ошибка «уже v2» |

### 5.3. Ручное тестирование

- [ ] Создать тестовую таблицу v1 с демо-данными
- [ ] Запустить миграцию
- [ ] Проверить все листы
- [ ] Проверить формулы баланса
- [ ] Проверить выпадающие списки
- [ ] Выполнить откат
- [ ] Проверить восстановление

---

## Фаза 6: Документация (Documentation)

### 6.1. Обновить README

- [ ] Описание v2.0
- [ ] Инструкция по миграции
- [ ] Новые функции

### 6.2. Обновить Инструкцию (лист)

- [ ] Новая структура баланса
- [ ] Свободные vs целевые платежи
- [ ] Регулярные цели

### 6.3. Добавить CHANGELOG

```markdown
## [2.0.0] - 2025-XX-XX

### Added
- Балансовая модель: платежи без привязки к цели
- Новые поля баланса: Резерв, Свободный остаток
- Регулярные цели с периодичностью
- Режим начисления `voluntary`
- Механизм миграции v1→v2

### Changed
- Лист «Сборы» переименован в «Цели»
- `collection_id` → `goal_id`
- Поле цели в платежах теперь опционально

### Deprecated
- Функция `PAYED_TOTAL_FAMILY` (алиас сохранён)
```

---

## Порядок реализации

```
Неделя 1:
├── Фаза 1: Утилиты миграции
├── Фаза 2.1: Миграция Сборы→Цели
└── Тесты для фазы 1-2.1

Неделя 2:
├── Фаза 2.2-2.4: Остальные листы
├── Фаза 3: Новые функции
└── Тесты для фазы 2-3

Неделя 3:
├── Фаза 4: Валидации и UI
├── Фаза 5: Полное тестирование
└── Фаза 6: Документация

Неделя 4:
├── Финальное тестирование
├── Исправление багов
└── Релиз v2.0
```

---

## Риски и митигации

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Потеря данных при миграции | Низкая | Автоматический бэкап |
| Несовместимость формул | Средняя | Алиасы для старых функций |
| Сложность для пользователей | Средняя | Подробная инструкция |
| Ошибки в расчётах | Средняя | Валидация сумм, тесты |

---

## Чек-лист готовности к релизу

- [ ] Все тесты проходят
- [ ] Миграция работает на тестовых данных
- [ ] Откат работает корректно
- [ ] Документация обновлена
- [ ] README содержит инструкцию
- [ ] CHANGELOG заполнен
- [ ] Демо-данные обновлены для v2
