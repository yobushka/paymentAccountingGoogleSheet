# Учёт сборов/взносов в Google Sheets (Google Apps Script)

Простой и быстрый учёт платежей для класса/группы прямо в Google Таблицах. Одна семья = один ребёнок. Сборы задаются целиком (без «статей»). Все расчёты моментальные и зависят только от текущих данных листов.

## Что умеет
- Структура листов: Инструкция, Семьи, Сборы, Участие, Платежи, Баланс, Детализация, DynCalc, Lists(скрытый)
- Выпадающие списки с метками «Название (ID)», логика автоматически извлекает ID
- Режимы начисления:
  - static_per_child — фикс на семью
  - shared_total_all — общая сумма T делится на N участников
  - shared_total_by_payers — общая сумма T делится поровну между оплатившими участниками (K плативших)
  - dynamic_by_payers — цель T распределяется среди плативших через cap x (water-filling): Σ min(P_i, x) = min(T, ΣP_i)
- Участие: по умолчанию все активные семьи; «Участвует» сужает, «Не участвует» исключает
- Баланс с селектором OPEN/ALL, «Оплачено всего», «Начислено всего», «Переплата (текущая)», «Задолженность`
- Детализация: пометка по каждой паре семья↔сбор (оплачено, начислено, разность, режим)
- Меню Funds: Setup, Rebuild validations, Generate IDs, Close Collection, Load Sample Data
- Меню Funds: Setup, Rebuild validations, Recalculate (Balance & Detail), Generate IDs, Close Collection, Load Sample Data
- Стайлинг, заметки к заголовкам (hover), валидации, именованные диапазоны

## Быстрый старт
1) Откройте пустую Google Таблицу → Расширения → Apps Script → вставьте содержимое `Code.gs` → сохраните.
2) В таблице: меню Funds → Setup / Rebuild structure.
3) Заполните «Семьи» (Активен=Да). Создайте «Сборы» (Статус=Открыт, режим, сумма, при необходимости — «Ссылка на гуглдиск»).
4) При необходимости настройте «Участие».
5) Вносите «Платежи» через выпадающие «Название (ID)». Сумма > 0.
6) Смотрите «Баланс» и «Детализация». Для динамических сборов используйте Close Collection для фиксации x.

## Листы и поля
- Семьи: Ребёнок ФИО, контакты, Активен, family_id (авто)
- Сборы: Название, Статус (Открыт/Закрыт), Начисление, Параметр суммы, Фиксированный x, collection_id (авто), Ссылка на гуглдиск (опц.)
- Участие: collection_id (label), family_id (label), Статус, Комментарий
- Платежи: Дата (справочно), family_id (label), collection_id (label), Сумма (>0), Способ, Комментарий, payment_id (авто)
- Баланс: family_id, Имя ребёнка, Переплата (текущая), Оплачено всего, Начислено всего, Задолженность; селектор I1: OPEN/ALL
- Детализация: family_id, Имя ребёнка, collection_id, Название сбора, Оплачено, Начислено, Разность (±), Режим; селектор K1: OPEN/ALL

Скрытый лист Lists формирует именованные диапазоны для валидаций:
- OPEN_COLLECTIONS_LABELS — открытые сборы «Название (ID)»
- COLLECTIONS_LABELS — все сборы
- ACTIVE_FAMILIES_LABELS — активные семьи «Имя (ID)»
- FAMILIES_LABELS — все семьи

## Режимы начисления и примеры
- static_per_child: начислено участнику = «Параметр суммы»; исключённым — 0.
- shared_total_all: начислено = T/N, где N — число участников.
- shared_total_by_payers: начислено = T/K только оплатившим участникам, где K — число участников с платежами > 0 (с учётом участия). Не платившим — 0.
  Пример: T=10 000; оплатили 4 семьи → каждому начислено 2 500; остальные получают 0.
- dynamic_by_payers: начислено семье i = min(P_i, x), где x такое, что Σ min(P_i, x) = min(T, ΣP_i). До закрытия x считается динамически, после — берётся «Фиксированный x».
  Пример: T=500; платежи=[2000,1333] → x=250 → начислено по 250 каждой из двух семей.

## Пересчёт Баланса и Детализации
- После изменения режима/параметров начисления или массовых правок «Участие»/«Платежи» используйте Funds → Recalculate (Balance & Detail), чтобы принудительно обновить расчёты.
- Баланс также авто‑обновляется при правках на листах «Платежи», «Семьи», «Сборы». Детализация пересчитывается автоматически при касании формулы или через Recalculate.

## Формулы и функции
- LABEL_TO_ID(value) — извлекает ID из «Название (ID)» или возвращает исходное, если это уже ID
- PAYED_TOTAL_FAMILY(family) — сумма всех платежей семьи
- ACCRUED_FAMILY(family, statusFilter) — начислено семье по режимам и участию; statusFilter: OPEN или ALL
- DYN_CAP(T, payments_range) — cap x по water-filling
- Дополнительно: ACCRUED_BREAKDOWN, DEBUG_COLLECTION_ACCRUAL, DEBUG_BALANCE_ACCRUAL, TEST_DYN_CAP

## Закрытие динамического сбора
Funds → Close Collection → введите collection_id (например, C003). Скрипт посчитает x по фактическим платежам участников, запишет «Фиксированный x» и поставит Статус=Закрыт.

## Производительность
- Всё чтение/запись пакетно; формулы «Баланс» ограничены фактическим числом семей
- «Детализация» генерируется одной функцией из батч‑данных, чтобы избежать таймаутов
- Авто‑рефреш «Баланс» и «Детализация» только на значимые правки

## Подсказки
- Если выпадающие пустые — Funds → Rebuild data validations
- Если «Начислено» неожиданно 0 — проверьте лист «Участие» и «Активен» в «Семьи»
- Если что-то «сломалось» — запустите Setup / Rebuild structure

## Лицензия
Код публикуется как есть для использования внутри вашей таблицы. Внешних библиотек нет; только Google Apps Script API.
