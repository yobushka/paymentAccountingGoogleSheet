# Зачем

Все просто - задача - вести учет средств получаемых от родителей, serverless, zero-infrastructure и вот это всё...
Клиенты у всех на телефонах есть, учетки гугловые тоже... так что...

# Учёт сборов/взносов в Google Sheets (Google Apps Script)

Версия: 0.2

Простой и быстрый учёт платежей для класса/группы прямо в Google Таблицах. Одна семья = один ребёнок. Сборы задаются целиком (без «статей»). Все расчёты моментальные и зависят только от текущих данных листов.

## Три базовых листа = 90% успеха
- Семьи — справочник семей/контактов и признак «Активен». Именно отсюда берутся участники по умолчанию.
- Сборы — список всех сборов: режим начисления, сумма/параметры, статус Открыт/Закрыт.
- Платежи — все входящие платежи с выбором семьи и сбора по метке «Название (ID)»; сумма > 0.

Все остальные листы вспомогательные и собираются автоматически из этих трёх: «Баланс», «Детализация», «Сводка», «Lists» (скрытый), «Инструкция», «Выдача» (журнал вручений), «Статус выдачи» (дашборд). Лист «Участие» — опциональный фильтр участия (см. ниже); если он пуст, участвуют все активные семьи.

## Что умеет
- Структура листов: Инструкция, Семьи, Сборы, Участие, Платежи, Баланс, Детализация, Сводка, Выдача, Статус выдачи, Lists (скрытый)
- Выпадающие списки с метками «Название (ID)», логика автоматически извлекает ID
- Режимы начисления:
  - static_per_child — фикс на семью
  - shared_total_all — общая сумма T делится на N участников
  - shared_total_by_payers — общая сумма T делится поровну между оплатившими участниками (K плативших)
  - dynamic_by_payers — цель T распределяется среди плативших через cap x (water-filling): Σ min(P_i, x) = min(T, ΣP_i)
  - proportional_by_payers — цель T распределяется пропорционально взносам плативших: начисление i = T · P_i / ΣP
  - unit_price_by_payers — поштучная покупка по цене x (из «Фиксированный x»): начисление i = floor(P_i/x)·x (полные единицы)
- Участие: по умолчанию все активные семьи; «Участвует» сужает, «Не участвует» исключает
- Баланс с селектором OPEN/ALL, «Оплачено всего», «Начислено всего», «Переплата (текущая)», «Задолженность`
- Детализация: пометка по каждой паре семья↔сбор (оплачено, начислено, разность, режим)
- Сводка: динамическая таблица по сборам (цель, собрано, участники, плательщики, ещё плательщиков до закрытия, остаток)
- Меню Funds: Setup, Rebuild validations, Recalculate (Balance & Detail), Generate IDs, Close Collection, Load Sample Data
- Стайлинг, заметки к заголовкам (hover), валидации, именованные диапазоны

## Быстрый старт
1) Откройте пустую Google Таблицу → Расширения → Apps Script → вставьте содержимое `Code.gs` → сохраните.
2) В таблице: меню Funds → Setup / Rebuild structure.
3) Заполните «Семьи» (Активен=Да). Создайте «Сборы» (Статус=Открыт, режим, сумма, при необходимости — «Ссылка на гуглдиск»).
4) При необходимости настройте «Участие».
5) Вносите «Платежи» через выпадающие «Название (ID)». Сумма > 0.
6) Смотрите «Баланс» и «Детализация». Для динамических сборов используйте Close Collection для фиксации x.
7) Смотрите «Сводка» — оперативные итоги по каждому сбору (цель, собрано, участие, оценка доворота).

▶ Выдача единиц (опционально, для поштучных сборов)
8) В «Сборы» установите «К выдаче детям» = Да и режим начисления = unit_price_by_payers. Убедитесь, что «Фиксированный x» задан как цена за единицу (> 0).
9) Вносите вручения на листе «Выдача»: укажите дату (справочно), сбор и семью по меткам «Название (ID)», количество «Единиц» (> 0), «Кто выдал» (текст), «Выдано» = Да/Нет.
10) Откройте «Статус выдачи» — он заполняется автоматически: сколько единиц требуется (ceil(T/x)), оплачено (⌊собрано/x⌋), выдано (сумма «Единиц» с Выдано=Да), и остаток к выдаче.

### Порядок заполнения данных
1) Семьи — заполните карточки семей. Убедитесь, что у строк появились ID (колонка family_id). Если пусто, используйте Funds → Generate IDs (all sheets).
2) Сборы — добавьте нужные сборы. Выберите корректный тип начисления (поле «Начисление») и заполните суммы/параметры. Статус=Открыт. Для unit_price_by_payers укажите «Фиксированный x» как цену за единицу.
3) Платежи — вносите платежи: выберите семью и сбор по выпадающим «Название (ID)», укажите сумму (>0) и способ (СБП/карта/наличные).
4) Обновление — выполните Funds → Recalculate (Balance & Detail) и проверьте «Баланс», «Детализация», «Сводка».

### Пошагово с иллюстрациями

1. Открыть Apps Script из таблицы и создать сценарий:

  ![Открыть Apps Script](./screenshots/screen1.png)

2. Вставить код из `Code.gs` в редактор:

  ![Вставка кода](./screenshots/screen2.png)

3. Переименовать файл при необходимости и сохранить проект:

  ![Переименование файла](./screenshots/screen3.png)

4. Убедиться, что проект сохранён (значок «сохранено»):

  ![Сохранение проекта](./screenshots/screen5.png)

5. Вернуться в таблицу. Перед первым запуском меню может не отображаться до обновления:

  ![До появления меню](./screenshots/screen6.png)

6. Открыть меню Funds и выполнить Setup / Rebuild structure:

  ![Меню Funds появилось](./screenshots/screen7.png)

7. Ознакомиться с пунктами меню:

  ![Пункты меню](./screenshots/screen8.png)

## Листы и поля
- Семьи: Ребёнок ФИО, День рождения, Мама телеграм, Папа телеграм, контакты родителей, Активен, family_id (авто)
- Сборы: Название, Статус (Открыт/Закрыт), Дата начала, Дедлайн, Начисление, Параметр суммы, Фиксированный x, К выдаче детям (Да/Нет), Закупка из средств (опц.), Возмещено (опц.), Комментарий, collection_id (авто), Ссылка на гуглдиск (опц.)
- Участие: collection_id (label), family_id (label), Статус, Комментарий
- Платежи: Дата (справочно), family_id (label), collection_id (label), Сумма (>0), Способ, Комментарий, payment_id (авто)
- Баланс: family_id, Имя ребёнка, Переплата (текущая), Оплачено всего, Начислено всего, Задолженность; селектор I1: OPEN/ALL
- Детализация: family_id, Имя ребёнка, collection_id, Название сбора, Оплачено, Начислено, Разность (±), Режим; селектор K1: OPEN/ALL
- Сводка: collection_id, Название, Режим, Сумма цели, Собрано, Участников, Плательщиков, Единиц оплачено, Ещё плательщиков до закрытия, Остаток до цели; селектор K1: OPEN/ALL
- Выдача (журнал вручений): Дата выдачи (справочно), collection_id (label), family_id (label), Единиц (>0), Кто выдал, Выдано (Да/Нет), Комментарий
- Статус выдачи (дашборд): collection_id, Название, Статус, x (цена), Единиц требуется, Единиц оплачено, Единиц выдано, Остаток (шт)

Скрытый лист Lists формирует именованные диапазоны для валидаций:
- OPEN_COLLECTIONS_LABELS — открытые сборы «Название (ID)»
- COLLECTIONS_LABELS — все сборы
- ACTIVE_FAMILIES_LABELS — активные семьи «Имя (ID)»
- FAMILIES_LABELS — все семьи

## Если возникли проблемы — быстрое восстановление
- Чаще всего достаточно удалить проблемные листы (например, «Баланс», «Детализация», «Сводка», «Lists», «Инструкция», «Участие») и выполнить Funds → Setup / Rebuild structure — структура и валидации пересоздадутся автоматически.
- Данные на базовых листах «Семьи», «Сборы», «Платежи» сохранятся; они являются источником истины для всех расчётов.
- Лист «Участие» используется системой для явного управления участниками, но он опционален для заполнения. Если его не заполнять — участвуют все активные семьи. Удалять его не обязательно: Setup всё равно пересоздаст лист при восстановлении структуры.

## Режимы начисления и подробные примеры
- static_per_child (фикс на семью):
  - Один платит: начисление = ставка всем участникам, независимо от того, кто платил; плативший может иметь переплату.
  - Несколько платят: у всех участников одинаковое начисление = ставка; переплата/недоплата зависит от их платежей.
- shared_total_all (T/N на всех участников):
  - Один платит: начисление = T/N всем участникам; плативший может покрыть больше своей доли (переплата) до оплаты другими.
  - Несколько платят: каждому начислено одинаково = T/N; переплаты у ранних плательщиков до добора остальных.
- shared_total_by_payers (T/K только для оплативших):
  - Один платит: K=1 → начисление этому плательщику = T/1 = T; у него будет недоплата, если внёс < T.
  - Несколько платят: начисление каждой платившей семье = T/K; не платившие получают 0.
- dynamic_by_payers (water‑filling):
  - Один платит: x = min(T, P1) → начисление = min(P1, x) = P1, недоплаты нет (пока один платящий).
  - Несколько платят: находится x такое, что Σ min(P_i, x) = min(T, ΣP_i); начисление семье i = min(P_i, x). После закрытия используется «Фиксированный x».

- proportional_by_payers (пропорционально платившим):
  - Один платит: начисление = T (целиком этому плательщику), если он единственный плативший; у него будет недоплата, если внёс < T.
  - Несколько платят: начисление семье i = T · P_i / ΣP только среди плативших; не платившие получают 0.

- unit_price_by_payers (цена единицы — Фиксированный x):
  - Один платит: начисление = min(P1, x). Если P1 ≥ x, долг не образуется в рамках этого сбора для него; закупка считается за единицами по x.
  - Несколько платят: начисление семье i = floor(P_i/x)·x (только полные единицы). В «Сводке»: «Участников» = ceil(T/x), «Плательщиков» = ⌊Собрано/x⌋ (оплаченные единицы), «Ещё плательщиков» ≈ ceil(остаток/x).

### Выдача единиц: как это работает
- Включение: только для unit_price_by_payers. В «Сборы» поставьте «К выдаче детям» = Да и задайте «Фиксированный x» как цену за единицу (> 0).
- Журнал «Выдача»: заносите вручения вручную. Валидации: collection_id — из всех сборов (COLLECTIONS_LABELS), family_id — из всех семей (FAMILIES_LABELS), «Единиц» > 0, «Выдано» = Да/Нет.
- Дашборд «Статус выдачи» формируется автоматически и показывает:
  - Единиц требуется = ceil(T/x)
  - Единиц оплачено = ⌊собрано/x⌋ (по платежам)
  - Единиц выдано = сумма «Единиц» с Выдано=Да
  - Остаток (шт) = max(0, Требуется − Выдано)
Примечания: дашборд учитывает только поштучные сборы с валидной ценой x и включённым флагом. Обновляется при изменениях на «Сборы», «Платежи» и «Выдача», а также через Recalculate.

## Сценарии из жизни: что выбрать и почему учёт разный

Ниже — типовые сюжеты из практики с рекомендацией режима, принципом справедливости и коротким числовым примером.

1) static_per_child — «фикс с семьи»
- Когда: одинаковая сумма для каждой семьи независимо от того, платили они или нет. Примеры: «Ежемесячный классный фонд по 500 ₽», «Организационный взнос 300 ₽».
- Почему такой учёт: услуга/польза одинакова для всех участников (каждая семья несёт равную долю), поэтому начисление идёт всем участвующим.
- Как считается: каждому участнику списывается ставка S.
- Пример: 10 семей, S=500 → цель = 10×500=5000. Трое заплатили по 500, остальные позже. У ранних временно переплата, но долгов нет у тех, кто внёс S.

2) shared_total_all — «делим общую сумму на всех участников»
- Когда: известна общая цель T (например, аренда автобуса), и справедливо разделить её между всеми, кто участвует. Примеры: «Поездка T=12 000 ₽ на 8 детей», «Печать фотографий T=6 000 ₽ на класс».
- Почему такой учёт: польза/затраты разделяются равными долями между всеми участниками, независимо от того, кто платил раньше.
- Как считается: доля = T/N, начисляется всем участникам; ранние платежи могут казаться «переплатой», пока не доберут остальные.
- Пример: T=12 000, N=8 → 1500 ₽ каждому. Если семья заплатила 3000, у неё временная переплата 1500.

3) shared_total_by_payers — «делим общую сумму только между платившими»
- Когда: расходы должны нести только те, кто реально внес деньги. Примеры: «Спонтанный подарок от тех, кто скинулся», «Добровольный сбор T=10 000 ₽ на ремонт кабинета без обязаловки».
- Почему такой учёт: принцип добровольности — доля формируется только среди тех, кто участвовал платежом; не платившие не получают начислений/долгов.
- Как считается: доля = T/K, где K — число плательщиков; начисление только плательщикам.
- Пример: T=10 000, платило 4 семьи → по 2500 начислено каждому из этих 4; остальные — 0.

4) dynamic_by_payers — «динамическое выравнивание (cap x, water‑filling)»
- Когда: общая цель T известна, но вносят неравномерно/в разное время, и нужно «выравнивать» ранние переплаты по мере поступлений. Примеры: «Сбор на оборудование T=9000», «Длинный сбор, где идут частичные взносы».
- Почему такой учёт: справедливость через верхнюю границу x для каждого плательщика: начисление i = min(P_i, x). x подбирается так, чтобы Σ min(P_i, x) = min(T, ΣP_i). После закрытия x фиксируется — все видят итоговую равную «планку».
- Как считается: пока сбор открыт — x пересчитывается по фактическим платежам; при закрытии записывается в «Фиксированный x», дальше берётся из него.
- Пример: T=9000, платежи [2000,2000,700,700,700,700,700] → x≈1250; начисления: [1250,1250,700,700,700,700,700].

5) proportional_by_payers — «пропорционально внесённым суммам (без долгов)»
- Когда: это скорее «пожертвования до цели», где никто не должен, но хочется корректно распределить «списание» по взносам. Примеры: «Помощь классу T=8000», «Сбор на подарки кому удобно, без обязаловки».
- Почему такой учёт: кто внёс больше — у того больше «списано», но никогда не больше платежа; не платившие ничего не должны.
- Как считается: берём target = min(T, ΣP); начисление i = P_i × (target/ΣP). При недоборе списывается весь платёж, при переборе — все уменьшаются пропорционально.
- Пример: T=8000, платежи [3000,2000,1500,800,500] (Σ=7800) → списываем 7800 пропорционально долям, долгов не возникает.

6) unit_price_by_payers — «поштучная закупка по цене x»
- Когда: покупаются одинаковые «единицы» с фиксированной ценой (форма, тетради, билеты), и начисление идёт только плательщику, максимум до x. Примеры: «Ученический комплект x=78 ₽ за штуку», «Спортивная форма x=1500 ₽».
- Почему такой учёт: каждая оплаченная единица «закрывает» одну штуку, долг по самому этому сбору не образуется, если внесено ≥ x; не платил — нет списания.
- Как считается: начисление i = floor(P_i/x)·x (только полные единицы), только платившим. В «Сводке»: Участников ≈ ceil(T/x) — сколько штук нужно; Единиц оплачено = ⌊Собрано/x⌋ — сколько штук уже профинансировано; Плательщиков — число уникальных плативших семей.
- Пример: T=780, x=78; платежи 8×78 и несколько частичных → Участников=10, Плательщиков=8, Остаток=156 (2 штуки).

Краткий навигатор выбора режима
- Фикс на всех одинаково? → static_per_child.
- Есть общая цель и участвуют все? → shared_total_all.
- Добровольно: платит кто хочет — делим только среди плативших? → shared_total_by_payers.
- Нужна «честная планка» при неравномерных платежах и потом зафиксировать итог? → dynamic_by_payers.
- Пожертвования без долгов (списывать пропорционально факту) → proportional_by_payers.
- Поштучные покупки с ценой за штуку → unit_price_by_payers.

## Пересчёт Баланса, Детализации и Сводки
- После изменения режима/параметров начисления или массовых правок «Участие»/«Платежи» используйте Funds → Recalculate (Balance & Detail) — он обновляет также «Сводка».
- Баланс авто‑обновляется при правках на «Платежи», «Семьи», «Сборы». «Детализация» и «Сводка» пересчитываются автоматически (через тик) или через Recalculate.

## Формулы и функции
- LABEL_TO_ID(value) — извлекает ID из «Название (ID)» или возвращает исходное, если это уже ID
- PAYED_TOTAL_FAMILY(family) — сумма всех платежей семьи
- ACCRUED_FAMILY(family, statusFilter) — начислено семье по режимам и участию; statusFilter: OPEN или ALL
- DYN_CAP(T, payments_range) — cap x по water-filling
 

## Закрытие динамического сбора
Funds → Close Collection → введите collection_id (например, C003). Скрипт посчитает x по фактическим платежам участников, запишет «Фиксированный x» и поставит Статус=Закрыт. Для других режимов «Фиксированный x» не изменяется при закрытии.

## Производительность
- Всё чтение/запись пакетно; формулы «Баланс» ограничены фактическим числом семей
- «Детализация» генерируется одной функцией из батч‑данных, чтобы избежать таймаутов
- Авто‑рефреш «Баланс» и «Детализация» только на значимые правки

## Подсказки
- Если выпадающие пустые — Funds → Rebuild data validations
- Если «Начислено» неожиданно 0 — проверьте лист «Участие» и «Активен» в «Семьи»
- Если что-то «сломалось» — запустите Setup / Rebuild structure

## Ссылки
- Репозиторий: https://github.com/yobushka/paymentAccountingGoogleSheet

## Disclaimer
- Этот инструмент в версии 0.2 только начинает использоваться для личных целей. Contribution & feedback welcome.
- Следите за обработкой персональных данных: передача ПДн за пределы вашей юрисдикции может быть незаконной. Google (и Google Sheets) — иностранная компания; убедитесь, что вы соблюдаете применимое законодательство и локальные политики.

## Лицензия
Код публикуется как есть для использования внутри вашей таблицы. Внешних библиотек нет; только Google Apps Script API.
